@model BoxCricketBuddy.Models.Venue
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="row">
    <div class="col-md-6">
        <div id="carouselExample" class="carousel slide" data-bs-ride="carousel">
            <div class="carousel-inner">
                @for(int i=0;i<Model.Images.Count();i++){
                    var img = Model.Images.ElementAt(i);
                    <div class="carousel-item @(i==0?"active":"")">
                        <img src="@img" class="d-block w-100" alt="">
                    </div>
                }
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#carouselExample" data-bs-slide="prev">
                <span class="carousel-control-prev-icon"></span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#carouselExample" data-bs-slide="next">
                <span class="carousel-control-next-icon"></span>
            </button>
        </div>
    </div>
    <div class="col-md-6">
        <h3>@Model.Name</h3>
        <p class="text-muted"><i class="fas fa-map-marker-alt"></i> @Model.Address</p>
        <p>@Model.Description</p>
        <p><strong>Price:</strong> ₹@Model.Price/hour</p>
        <p><strong>Facilities:</strong> @string.Join(", ", Model.Facilities)</p>

        <h5>Available Time Slots</h5>
        <div id="timeSlots" class="d-flex flex-wrap"></div>
        <div id="bookBtnContainer" class="mt-3"></div>
    </div>
</div>

<!-- Booking Modal -->
<div class="modal fade" id="bookingModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Book Slot</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="bookingForm">
            <input type="hidden" id="venueId" value="@Model.Id" />
            <input type="hidden" id="venueName" value="@Model.Name" />
            <div class="mb-2"><label>Name</label><input class="form-control" id="customerName" required /></div>
            <div class="mb-2"><label>Email</label><input class="form-control" id="customerEmail" type="email" required /></div>
            <div class="mb-2"><label>Phone</label><input class="form-control" id="customerPhone" required /></div>
            <div class="mb-2"><label>Selected Time</label><input class="form-control" id="selectedTime" readonly /></div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" onclick="confirmBooking()">Confirm</button>
      </div>
    </div>
  </div>
</div>

@section Scripts{
<script>
    const basePrice = @Model.Price;
    function generateSlots(){
        const container = document.getElementById('timeSlots');
        container.innerHTML = '';
        const nowHour = new Date().getHours();
        for(let h=6; h<=22; h++){
            const isPast = h <= nowHour;
            const isBooked = Math.random() > 0.75;
            const price = basePrice + (h>=18?100:0);
            const slot = document.createElement('div');
            slot.className = 'time-slot m-1 p-2';
            if(isPast || isBooked) slot.classList.add('booked');
            slot.innerHTML = `<div><strong>${String(h).padStart(2,'0')}:00 - ${String(h+1).padStart(2,'0')}:00</strong></div><div>₹${price}</div>`;
            if(!isPast && !isBooked){
                slot.style.cursor='pointer';
                slot.onclick = ()=> selectSlot(h, price);
            }
            container.appendChild(slot);
        }
    }

    let selected = null;
    function selectSlot(hour, price){
        selected = { start: `${String(hour).padStart(2,'0')}:00`, end: `${String(hour+1).padStart(2,'0')}:00`, price };
        document.getElementById('selectedTime').value = `${selected.start} - ${selected.end} (₹${selected.price})`;
        document.getElementById('bookBtnContainer').innerHTML = `<button class='btn btn-primary' data-bs-toggle='modal' data-bs-target='#bookingModal'>Book Now</button>`;
    }

    function confirmBooking(){
        const data = new FormData();
        data.append('VenueId', document.getElementById('venueId').value);
        data.append('VenueName', document.getElementById('venueName').value);
        data.append('Date', new Date().toISOString());
        data.append('StartTime', selected.start);
        data.append('EndTime', selected.end);
        data.append('CustomerName', document.getElementById('customerName').value);
        data.append('CustomerEmail', document.getElementById('customerEmail').value);
        data.append('CustomerPhone', document.getElementById('customerPhone').value);
        data.append('Amount', selected.price);

        fetch('/Venues/Book', { method: 'POST', body: data })
            .then(r => r.json())
            .then(j => {
                if(j.success){
                    const modal = bootstrap.Modal.getInstance(document.getElementById('bookingModal'));
                    modal.hide();
                    alert('Booking confirmed. Ref: ' + j.reference);
                    generateSlots();
                }
            });
    }

    generateSlots();
</script>
}
